
<!DOCTYPE html>
<html lang="fa">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>صفحه‌ی پشتیبان</title>

    <!-- External files2 -->
    <link rel="stylesheet" href="/site_static/django_chat_app/css/supporter.css">

</head>
<body>

    <section class="chatapp" id="chatapp">

        <div class="alert_box" v-if="alert">
            <p>[[ alert ]]</p>
        </div>

        <p class="d-none" id="supporter_uid">{{ supporter_uid }}</p>

        <div class="chatapp__msg">

            <!-- + header -->
            <div class="msg__header">
                <div class="msg__wrapper">

                    <div class="header__info">
                        <img src="/site_static/django_chat_app/img/supporter.png" alt="">
                        <div>
                            <span v-if="client_id" :title="client_id.slice(0,5) + '***' + client_id.slice(31)">[[ client_name ]]</span>
                            <span v-if="client_id">[[ receiver_status == 'online' ? 'آنلاین' : 'آخرین بازدید به تازگی' ]]</span>
                            <span v-else>به پنل پشتیبان خوش آمدید.</span>
                        </div>
                    </div>

                    <div class="header__option">
                        <div class="wrapper_btns">
                            <button class="btns_base" v-if="client_id" @click="open_report_box"><img src="/site_static/django_chat_app/img/report.png" alt="report user"></button>
                            <button class="btns_base" v-if="client_id" @click="openclose_copyreadymsg"><img src="/site_static/django_chat_app/img/copy.png" alt="copy msg box"></button>
                            <button class="btns_base" v-if="client_id" @click="reset_close_chat_box"><img src="/site_static/django_chat_app/img/close.png" alt="close chat box"></button>
                            
                            <div class="reportbox_section" v-if="which_toggle_popup == 'report'">

                                <form @submit.prevent="send_report">
                                    <div class="chatapp_formcontrol" style="margin-bottom: 17px !important;">
                                        <select v-model="report_item">
                                            <option value="badterms">استفاده از کلمات نامناسب</option>
                                            <option value="others">دلایل دیگر</option>
                                        </select>
                                    </div>
    
                                    <div class="chatapp_formcontrol">
                                        <label>متن گزارش</label>
                                        <textarea v-model="report_cause"></textarea>
                                    </div>
    
                                    <div class="chatapp_button">
                                        <button type="button" @click="send_report">ثبت گزارش</button>
                                    </div>
                                </form>
                            </div>

                            <div class="copybox_section" v-if="which_toggle_popup == 'copybox'">

                                <div class="wrapper_boxes">

                                    <div class="msg_item" v-for="ready_msg in ready_msgs" :key="ready_msg.id">
                                        <p :title="ready_msg.content">[[ ready_msg.subject ]]</p>
                                        <div class="wrapper_btns_msgs">
                                            <button v-if="ready_msg.supporter__supporter_uid == supporter_uid && !ready_msg.is_public" @click="delete_ready_msg(ready_msg.id)"><img src="/site_static/django_chat_app/img/delete.png" alt="delete ready msg item"></button>
                                            <div class="wrapper_2btn_msgs">
                                                <button @click="msg_input+=ready_msg.content" v-if="client_id"><img src="/site_static/django_chat_app/img/plus.png" alt="add to input"></button>
                                                <button @click="copy_ready_msg(ready_msg.content)"><img src="/site_static/django_chat_app/img/copy.png" alt="copy to clipboard"></button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>


                    </div>

                </div>
            </div>
            <!-- - header -->

            <!-- + tabbar -->
            <div class="msg__tabbar">
                <div class="tab_item" :class="tab_id_active == 'menu' ? 'tab_active' : ''" @click="open_tab_data('menu')">صفحه‌ی اصلی</div>
                <div class="tab_item" :class="tab_id_active == 'yourunreads' ? 'tab_active' : ''" @click="open_tab_data('yourunreads')">پیام‌های ناخوانده‌ی شما</div>
                <div class="tab_item" :class="tab_id_active == 'unreads' ? 'tab_active' : ''" @click="open_tab_data('unreads')">سایر پیام‌های ناخوانده</div>
                <div class="tab_item" :class="tab_id_active == 'allpages' ? 'tab_active' : ''" @click="open_tab_data('allpages')">کاربران</div>
            </div>
            <!-- - tabbar -->

            <!-- + body -->
            <div class="msg__body">        
                <div class="body__wrapper">

                    <div v-if="tab_id_active=='menu'" class="tab_menu_links">
                        
                        <!-- links -->
                        <div class="wrapper_buttons">
                            <p><a @click="menu_active_tab = 'addnewmsg'">نوشتن پیام آماده</a></p>
                        </div>

                        <!-- outputs -->
                        <div class="wrapper_output" v-if="menu_active_tab">

                            <form novalidate @submit.prevent="submit_new_readymsg" v-if="menu_active_tab == 'addnewmsg'">
                                
                                <div class="chatapp_formcontrol" style="margin-bottom: 17px !important; margin-top: 7px;">
                                    <label>عنوان متن</label>
                                    <input type="text" id="subject-chatinput" v-model="new_readymsg_subject" autocomplete="off" autofocus>
                                </div>
                                <div class="chatapp_formcontrol">
                                    <label>محتوای متن</label>
                                    <textarea id="content-chatinput" rows="4" v-model="new_readymsg_content" autocomplete="off"></textarea>
                                </div>
                                <div class="chatapp_button">
                                    <button type="submit">ذخیره</button>
                                </div>
                            </form>

                        </div>

                    </div>

                    <div v-if="tab_id_active=='yourunreads'" :class="tab_data_is_show == false ? 'd-none' : ''">
                        
                        <!-- list pages -->
                        <div class="wrapper__chatboxes">
                            <template v-for="(msg, index) in unreads_thissupporter" :key="msg">
                                <div class="chat__box" :class="'page1_item_' + index" @click="show_user_chat_page(msg.owner_id, msg.owner_name, `page1_item_${index}`, 'thissupporter', index)">
                                    <div class="user_date_div">
                                        <div>[[ msg.owner_name ]]</div>
                                        <div>[[ msg.owner_id.slice(0,3) ]]****[[ msg.owner_id.slice(7) ]] [[ msg.status == 'online' ? ' - آنلاین' : ' - اخیرا' ]]</div>
                                    </div>
                                    <div class="unreadmsg_counter">[[ msg.counter ]]</div>
                                </div>
                            </template>
                        </div>

                    </div>

                    <div v-if="tab_id_active=='unreads'" :class="tab_data_is_show == false ? 'd-none' : ''">

                        <!-- list pages -->
                        <div class="wrapper__chatboxes">
                            <template v-for="(msg, index) in unreads_nosupoorter" :key="msg">
                                <div class="chat__box" :class="'page2_item_' + index" @click="show_user_chat_page(msg.owner_id, msg.owner_name, `page2_item_${index}`, 'nosupoorter', index)">
                                    <div class="user_date_div">
                                        <div>[[ msg.owner_name ]]</div>
                                        <div>[[ msg.owner_id.slice(0,3) ]]****[[ msg.owner_id.slice(7) ]] [[ msg.status == 'online' ? ' - آنلاین' : ' - اخیرا' ]]</div>
                                    </div>
                                    <div class="unreadmsg_counter">[[ msg.counter ]]</div>
                                </div>
                            </template>
                        </div>

                    </div>
                    
                    <div v-if="tab_id_active=='allpages'" :class="tab_data_is_show == false ? 'd-none' : ''">

                        <!-- list pages -->
                        <div class="wrapper__chatboxes">
                            <template v-for="(chat, index) in chat_to_all" :key="chat">
                                <div class="chat__box" :class="'page3_item_' + index" @click="show_user_chat_page(chat.user_chat_uid, `${chat.first_name} ${chat.last_name}`, `page3_item_${index}`, 'anyone', index)">
                                    <div class="user_date_div">
                                        <div>[[ chat.first_name ]] [[ chat.last_name ]]</div>
                                        <div>[[ chat.user_chat_uid.slice(0,3) ]]****[[ chat.user_chat_uid.slice(7) ]]</div>
                                    </div>
                                </div>
                            </template>
                        </div>

                    </div>

                    <!-- + messages wrapper -->
                    <div class="all__msg__wrapper" :class="show_msg_container == true ? '' : 'd-none'">

                        <template v-for="msg_item in message_list" :key="msg_item.id">
                            <div v-if="!msg_item.is_deleted" class="one_msg_wrapper">

                                <ul :id="`msg-menu-bar-${msg_item.id}`" class="msg-menu-bar d-none" :class="msg_item.sender_type == 'supporter' ? 'msg-menu-bar--left' : 'msg-menu-bar--right'">
                                    <li @click="reply_msg(`chatapp_msg_${msg_item.id}`, msg_item.id)"><img src="/site_static/django_chat_app/img/reply.png" alt=""> پاسخ دادن</li>
                                    <li @click="copy_ready_msg(msg_item.text)"><img src="/site_static/django_chat_app/img/copy.png" alt=""> کپی متن</li>
                                    <li v-if="edit_user_msg && msg_item.sender_type == 'supporter' && !msg_item.is_edited" @click="edit_message(`chatapp_msg_${msg_item.id}`, msg_item.id)"><img src="/site_static/django_chat_app/img/edit.png" alt=""> ویرایش پیام</li>
                                    <li v-if="delete_user_msg && msg_item.sender_type == 'supporter'" @click="delete_message(msg_item.id)"><img src="/site_static/django_chat_app/img/delete.png" alt=""> حذف پیام</li>
                                </ul>

                                <div class="msg" :class="msg_item.sender_type == 'supporter' ? 'msg__right' : 'msg__left'" :id="'chatapp_msg_' + msg_item.id">
                                    <p v-if="msg_item.reply_title" class="msg__replied" :class="msg_item.sender_type == 'supporter' ? 'msg__replied--right' : 'msg__replied--left'" @click="msg_replied(`chatapp_msg_${msg_item.reply_id}`)">
                                        <span>[[ msg_item.reply_title == 'supporter' ? 'شما' : 'کاربر' ]]</span>
                                        <span v-if="!msg_item.reply_is_deleted">[[ msg_item.reply_msg ]]</span>
                                        <span v-else>این پیام حذف شده است</span>
                                    </p>
                                    
                                    <p class="msg__content">
                                        [[ msg_item.text ]]
                                    </p>
                                    <div class="msg__info">
                                        <div class="msg__info__status" v-if="msg_item.sender_type == 'supporter'">
                                            <img v-if="msg_item.is_seen" src="/site_static/django_chat_app/img/double-check.png" alt="double check status">
                                            <img v-else src="/site_static/django_chat_app/img/single-check.png" alt="single check status">
                                        </div>
                                        <div class="msg__info__clock">[[ msg_item.created ]]</div>
                                        <div class="msg__info__edited" v-if="msg_item.is_edited">ویرایش شده</div>
                                    </div>
                                    <div class="reply_one_msg" :class="msg_item.sender_type == 'supporter' ? 'reply_one_msg--right' : 'reply_one_msg--left'">
                                        <span @click="reply_msg(`chatapp_msg_${msg_item.id}`, msg_item.id)">پاسخ دادن</span>
                                        <br><br>
                                        <span class="toggle_mneubar" @click="show_menu_bar(`msg-menu-bar-${msg_item.id}`)">بیشتر</span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="msg_item.is_deleted && show_deleted_msg">
                                <div class="msg__content deleted_msg"  :class="msg_item.sender_type == 'supporter' ? 'msgdel__right' : 'msgdel__left'">
                                    <img src="/site_static/django_chat_app/img/delete.png" alt=""> این پیام حذف شده است.
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </template>

                    </div>
                    <!-- - messages wrapper -->

                </div>
            </div>
            <!-- - body -->

            <!-- + send msg -->
            <div class="body__inputs d-none">
                <form novalidate @submit.prevent="sned_msg_socket">
                    <div class="forminput_wrapper">

                        <input type="text" v-model="msg_input" id="text-chatinput" autocomplete="off" placeholder="پیام خود را وارد کنید:">
                        <button class="show_emoji" type="button" @click="show_emojibar">
                            <img src="/site_static/django_chat_app/img/emoji.png" alt="toggle emojis">
                        </button>

                        <div class="reply_msg_wrapper d-none">
                            <button class="close_replybar" type="button" @click="close_replybar">&times;</button>
                            <div>
                                <p class="reply__writer"></p>
                                <p class="reply__content"></p>
                                <p class="reply__reply_id d-none"></p>
                            </div>
                        </div>

                        <div class="emoji_wrapper d-none">
                            <div class="emoji_box">
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F600;')">&#x1F600;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F601;')">&#x1F601;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F602;')">&#x1F602;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F603;')">&#x1F603;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F604;')">&#x1F604;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F605;')">&#x1F605;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F606;')">&#x1F606;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F607;')">&#x1F607;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F608;')">&#x1F608;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F609;')">&#x1F609;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F60A;')">&#x1F60A;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F60B;')">&#x1F60B;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F60C;')">&#x1F60C;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F60D;')">&#x1F60D;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F60E;')">&#x1F60E;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F60F;')">&#x1F60F;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F610;')">&#x1F610;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F611;')">&#x1F611;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F612;')">&#x1F612;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F613;')">&#x1F613;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F614;')">&#x1F614;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F615;')">&#x1F615;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F616;')">&#x1F616;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F617;')">&#x1F617;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F618;')">&#x1F618;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F619;')">&#x1F619;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F61A;')">&#x1F61A;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F61B;')">&#x1F61B;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F61C;')">&#x1F61C;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F61D;')">&#x1F61D;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F61E;')">&#x1F61E;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F61F;')">&#x1F61F;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F620;')">&#x1F620;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F621;')">&#x1F621;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F622;')">&#x1F622;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F623;')">&#x1F623;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F624;')">&#x1F624;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F625;')">&#x1F625;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F626;')">&#x1F626;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F627;')">&#x1F627;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F628;')">&#x1F628;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F629;')">&#x1F629;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F62A;')">&#x1F62A;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F62B;')">&#x1F62B;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F62C;')">&#x1F62C;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F62D;')">&#x1F62D;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F62E;')">&#x1F62E;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F62F;')">&#x1F62F;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F630;')">&#x1F630;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F631;')">&#x1F631;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F632;')">&#x1F632;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F633;')">&#x1F633;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F634;')">&#x1F634;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F635;')">&#x1F635;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F636;')">&#x1F636;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F637;')">&#x1F637;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F641;')">&#x1F641;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F642;')">&#x1F642;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F643;')">&#x1F643;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F644;')">&#x1F644;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F910;')">&#x1F910;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F911;')">&#x1F911;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F912;')">&#x1F912;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F913;')">&#x1F913;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F914;')">&#x1F914;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F915;')">&#x1F915;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F917;')">&#x1F917;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F918;')">&#x1F918;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F919;')">&#x1F919;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F91A;')">&#x1F91A;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F91B;')">&#x1F91B;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F91C;')">&#x1F91C;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F91D;')">&#x1F91D;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F91E;')">&#x1F91E;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F91F;')">&#x1F91F;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F920;')">&#x1F920;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F921;')">&#x1F921;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F922;')">&#x1F922;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F923;')">&#x1F923;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F924;')">&#x1F924;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F925;')">&#x1F925;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F926;')">&#x1F926;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F927;')">&#x1F927;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F928;')">&#x1F928;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F929;')">&#x1F929;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F92A;')">&#x1F92A;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F92B;')">&#x1F92B;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F92C;')">&#x1F92C;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F92D;')">&#x1F92D;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F92E;')">&#x1F92E;</div>
                                <div class="emoji_item" @click="add_emoji_toinput('&#x1F92F;')">&#x1F92F;</div>
                            </div>
                        </div>

                        <button type="submit" class="submit_msg_client">
                            <img src="/site_static/django_chat_app/img/send.png" alt="send image">
                        </button>
                    </div>
                </form>

                <div class="btn_last_msg d-none" @click="go_to_bottom_of_box">
                    <button @click="go_to_bottom_of_box">
                        <img src="/site_static/django_chat_app/img/gotodown.png" alt="go to last msg img">
                        <div class="unreadmsg_counter d-none"></div>
                    </button>
                </div>

            </div>
            <!-- - send msg -->

        </div>

    </section>

<!-- <script type="text/javascript" src="/site_static/django_chat_app/js/supporter.js"></script> -->
<script type="text/javascript" src="/site_static/django_chat_app/js/vue3.js"></script>

<script>

    document.getElementById('chatapp').addEventListener('click', (ev)=> {
        if(!ev.target.closest('span.toggle_mneubar')){
            document.querySelectorAll('.chatapp ul.msg-menu-bar').forEach(element => {
                if(!element.classList.contains('d-none'))
                    element.classList.add('d-none');
            });
        }
    });

    /* DJANGO CHAT APP package */
    /* v1.0.0 */

    Vue.createApp({
        
        delimiters: [`[[`, `]]`],
        
        data() {
            return {
                // env variables
                env_dir: '',
                edit_user_msg: false,
                delete_user_msg: false,
                show_deleted_msg: false,
                is_set_env: false,

                supporter_uid: '',
                client_id: '',
                client_name: '',

                socket: '',
                msg_input: '',

                receiver_status: '',

                new_readymsg_subject: '',
                new_readymsg_content: '',

                ready_msgs: [],

                chat_to_all: [],

                tab_id_active: 'yourunreads',
                tab_data_is_show: true,
                show_msg_container: false,
                menu_active_tab: '',

                message_status_is_edit: false,

                message_list: [],
                unreads_nosupoorter_pre: [],
                unreads_nosupoorter: [],
                unreads_thissupporter_pre: [],
                unreads_thissupporter: [],

                which_toggle_popup: '',
                report_item: 'badterms',
                report_cause: '',

                alert: '',
            }
        },

        created() {
            this.set_setting();
        },

        mounted() {
            this.supporter_uid = document.getElementById('supporter_uid').innerText;
            this.get_board_msgs();
            this.start_socket();
        },

        methods: {
            
            // encrypt(salt, text) {
            //     const textToChars = (text) => text.split("").map((c) => c.charCodeAt(0));
            //     const byteHex = (n) => ("0" + Number(n).toString(16)).substr(-2);
            //     const applySaltToChar = (code) => textToChars(salt).reduce((a, b) => a ^ b, code);
            //     return text.split("").map(textToChars).map(applySaltToChar).map(byteHex).join("");
            // },

            // decrypt(salt, encoded) {
            //     const textToChars = (text) => text.split("").map((c) => c.charCodeAt(0));
            //     const applySaltToChar = (code) => textToChars(salt).reduce((a, b) => a ^ b, code);
            //     return encoded.match(/.{1,2}/g).map((hex) => parseInt(hex, 16)).map(applySaltToChar).map((charCode) => String.fromCharCode(charCode)).join("");
            // },

            open_tab_data(context) {
                this.tab_id_active = context;
                this.show_msg_container = false;
                this.tab_data_is_show = true;

                this.reset_close_chat_box()
            },

            open_report_box() {
                if(this.which_toggle_popup == 'report')
                    this.which_toggle_popup = '';
                else 
                    this.which_toggle_popup = 'report';
            },

            add_emoji_toinput(emoji) {
                this.msg_input += emoji;
                this.focus_msg_input();
            },
            show_menu_bar(elementID) {

                if(document.getElementById(elementID).classList.contains('d-none')) {
                    document.querySelectorAll('.chatapp .msg-menu-bar').forEach(element => {
                        element.classList.add('d-none');
                    });
                    document.getElementById(elementID).classList.remove('d-none');
                }
                else
                    document.getElementById(elementID).classList.add('d-none');
            },

            show_emojibar() {
                if(document.querySelector('section.chatapp .emoji_wrapper').classList.contains('d-none')){
                    document.querySelector('section.chatapp .emoji_wrapper').classList.remove('d-none');
                }else {
                    document.querySelector('section.chatapp .emoji_wrapper').classList.add('d-none');
                }
            },

            play_send_sound() {
                new Audio('/site_static/django_chat_app/media/send.mp3').play();
            },

            focus_msg_input() {
                setTimeout(() => {
                    document.querySelector('section.chatapp .body__inputs #text-chatinput').focus();
                }, 200);
            },

            set_setting() {

                if(this.is_set_env)
                    return;

                (async () => {
                    await fetch('/' +  window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/setting/', {
                        method: "POST",
                        headers: {
                            "Content-type": "application/x-www-form-urlencoded"
                        }
                    })
                    .then(response => response.json())
                    .then((response) => {
                        if(response.status == 200) {

                            this.env_dir = response.data.dir;
                            this.edit_user_msg = response.data.edit_supporter_msg;
                            this.delete_user_msg = response.data.delete_supporter_msg;
                            this.show_deleted_msg = response.data.show_deleted_msg;
                            this.is_set_env = true;

                            let language = window.location.pathname[1] + window.location.pathname[2];

                            // setting for direction
                            if(this.env_dir == 'ltr') {
                                document.querySelector('section.chatapp').classList.add('chatapp__ltr')
                            } else if(this.env_dir == 'rtl') {
                                document.querySelector('section.chatapp').classList.remove('chatapp__ltr')
                            } else if(this.env_dir == 'auto') {
                                if(language == 'fa' || language == 'ar')
                                    document.querySelector('section.chatapp').classList.remove('chatapp__ltr')
                                else
                                    document.querySelector('section.chatapp').classList.add('chatapp__ltr')
                            }
                        }
                    })
                    .catch(err => {
                        console.log('ERR: ', err);
                    });
                })();
            },

            get_board_msgs() {

                let formdata = new FormData();
                formdata.append('supporter_uid', this.supporter_uid);
                
                (async () => {
                    await fetch('/' + window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/supporter/unreads/', {
                        method: "POST",
                        body: new URLSearchParams(formdata),
                        headers: {
                            "Content-type": "application/x-www-form-urlencoded"
                        }
                    })
                    .then(response => response.json())
                    .then((response) => {
                        if(response.status == 200) {
                            
                            // set to board
                            this.set_unread_msgs_to_board(
                                response.unreads_nosupoorter,
                                response.unreads_thissupporter
                            )

                            this.chat_to_all = response.chat_to_all;
                        }
                    })
                    .catch(err => {
                        console.log('ERR: ', err);
                    });
                })();

            },

            set_unread_msgs_to_board(GetNosupoorter, GetThissupporter) {

                // get nosupoorter
                this.unreads_nosupoorter_pre = GetNosupoorter;
                let nosupoorter_count = {};
                let nosupoorter_result = [];

                this.unreads_nosupoorter_pre.forEach(element => {
                    nosupoorter_count[element.owner_id] = (nosupoorter_count[element.owner_id] || 0) + 1;
                });
                
                for (const key in nosupoorter_count) {
                    for (let i = 0; i < this.unreads_nosupoorter_pre.length; i++) {
                        if(key == this.unreads_nosupoorter_pre[i].owner_id) {
                            nosupoorter_result.push({
                                "owner_id": this.unreads_nosupoorter_pre[i].owner_id,
                                "owner_name": this.unreads_nosupoorter_pre[i].owner_name,
                                "counter": nosupoorter_count[key],
                                "status": ""
                            })
                            break;
                        }
                    }
                }
                this.unreads_nosupoorter = nosupoorter_result;
                
                // get thissupporter
                this.unreads_thissupporter_pre = GetThissupporter;
                let thissupporter_count = {};
                let thissupporter_result = [];

                this.unreads_thissupporter_pre.forEach(element => {
                    thissupporter_count[element.owner_id] = (thissupporter_count[element.owner_id] || 0) + 1;
                });
                
                for (const key in thissupporter_count) {
                    for (let i = 0; i < this.unreads_thissupporter_pre.length; i++) {
                        if(key == this.unreads_thissupporter_pre[i].owner_id) {
                            thissupporter_result.push({
                                "owner_id": this.unreads_thissupporter_pre[i].owner_id,
                                "owner_name": this.unreads_thissupporter_pre[i].owner_name,
                                "counter": thissupporter_count[key],
                                "status": ""
                            })
                            break;
                        }
                    }
                }
                this.unreads_thissupporter = thissupporter_result;
            },

            go_to_bottom_of_box() {
                document.querySelector('.msg__body .body__wrapper').scrollIntoView({ behavior: "smooth", block: "end"});
            },
            
            reply_msg(elementId, msgId) {
                this.focus_msg_input();
                let msgbox = document.getElementById(elementId);
                let reply_writer = '';
                let reply_id = msgId;
                let reply_content = document.querySelector(`#${elementId} .msg__content`).innerText;

                if(msgbox.classList.contains('msg__right'))
                    reply_writer = 'شما';
                else
                    reply_writer = 'کاربر';

                document.querySelector('.body__inputs .reply_msg_wrapper').classList.remove('d-none');
                document.querySelector('.body__inputs .reply_msg_wrapper .reply__writer').innerText = reply_writer;
                document.querySelector('.body__inputs .reply_msg_wrapper .reply__content').innerText = reply_content;
                document.querySelector('.body__inputs .reply_msg_wrapper .reply__reply_id').innerText = reply_id;
            },
            
            close_replybar() {
                this.message_status_is_edit = false;
                document.querySelector('.body__inputs .reply_msg_wrapper').classList.add('d-none');
                document.querySelector('.body__inputs .reply_msg_wrapper .reply__writer').innerText = '';
                document.querySelector('.body__inputs .reply_msg_wrapper .reply__content').innerText = '';
                document.querySelector('.body__inputs .reply_msg_wrapper .reply__reply_id').innerText = '';
            },

            msg_replied(scholl_msg) {
                let target = document.getElementById(scholl_msg); 

                if(target) {
                    let initial_bgcolor = '';

                    // change background color for message
                    if(target.classList.contains('msg__right')) {
                        initial_bgcolor = target.style.backgroundColor;
                        target.style.backgroundColor = '#1577c6';
                    } else if (target.classList.contains('msg__left')) {
                        initial_bgcolor = target.style.backgroundColor;
                        target.style.backgroundColor = '#c2c2c2';
                    }

                    setTimeout(() => {
                        target.style.backgroundColor = initial_bgcolor;
                    }, 3000);

                    // scroll to message
                    target.scrollIntoView({ behavior: "smooth", block: "end"});
                }
            },

            start_socket() {

                this.socket = new WebSocket( 'ws://' + window.location.host + '/ws/supporter/chat/' + this.supporter_uid + '/');
                
                let mythis = this;

                this.socket.onmessage = function(e) {

                    let message = JSON.parse(e.data);
                    console.log(message);

                    if(message._type_request == 'edit') {  /* just edit message */
                        mythis.message_list.forEach(element => {
                            if(element.id == message.reply_id) {
                                element.text = message.text;
                                element.is_edited = true;
                            }
                        });

                        return;
                    }

                    else if(message._type_request == 'del') {  /* just delete message */
                        mythis.message_list.forEach(element => {
                            if(element.id == message.id)
                                element.is_deleted = true;
                            if(element.reply_id == message.id)
                                element.reply_is_deleted = true;
                        });

                        return;
                    }

                    else if(message._type_request == 'seen'){
                        mythis.message_list.forEach(element => {
                            element.is_seen = true;
                        });
                    }

                    else if(message._type_request == 'status') {
                        if(mythis.client_id)
                            mythis.receiver_status = message.status;

                        mythis.unreads_thissupporter.forEach(element => {
                            if(element.owner_id == message.user_id) 
                                element.status = message.status;
                        });
                        mythis.unreads_nosupoorter.forEach(element => {
                            if(element.owner_id == message.user_id) 
                                element.status = message.status;
                        });
                    }

                    // add message to board
                    else if(message._type_request == 'send') {

                        if(message.client_have_supporter == 'yes') {

                            mythis.unreads_thissupporter_pre.push(message);
                            let thissupporter_count = {};
                            let thissupporter_result = [];
    
                            mythis.unreads_thissupporter_pre.forEach(element => {
                                thissupporter_count[element.owner_id] = (thissupporter_count[element.owner_id] || 0) + 1;
                            });
                            
                            for (const key in thissupporter_count) {
                                for (let i = 0; i < mythis.unreads_thissupporter_pre.length; i++) {
                                    if(key == mythis.unreads_thissupporter_pre[i].owner_id) {
                                        thissupporter_result.push({
                                            "owner_id": mythis.unreads_thissupporter_pre[i].owner_id,
                                            "owner_name": mythis.unreads_thissupporter_pre[i].owner_name,
                                            "counter": thissupporter_count[key],
                                            "status": ""
                                        })
                                        break;
                                    }
                                }
                            }
                            mythis.unreads_thissupporter = thissupporter_result;
                        }
                        else if(message.client_have_supporter == 'no') {

                            mythis.unreads_nosupoorter_pre.push(message);
                            let nosupoorter_count = {};
                            let nosupoorter_result = [];

                            mythis.unreads_nosupoorter_pre.forEach(element => {
                                nosupoorter_count[element.owner_id] = (nosupoorter_count[element.owner_id] || 0) + 1;
                            });

                            for (const key in nosupoorter_count) {
                                for (let i = 0; i < mythis.unreads_nosupoorter_pre.length; i++) {
                                    if(key == mythis.unreads_nosupoorter_pre[i].owner_id) {
                                        nosupoorter_result.push({
                                            "owner_id": mythis.unreads_nosupoorter_pre[i].owner_id,
                                            "owner_name": mythis.unreads_nosupoorter_pre[i].owner_name,
                                            "counter": nosupoorter_count[key],
                                            "status": ""
                                        })
                                        break;
                                    }
                                }
                            }
                            mythis.unreads_nosupoorter = nosupoorter_result;
                        }

                        setTimeout(()=> {
                            mythis.go_to_bottom_of_box();
                        }, 400);
                    }
                    
                    if(message._type_request == 'send' && mythis.client_id && !message.message_id) {
                        mythis.message_list.push(message);
                        setTimeout(()=> {
                            mythis.go_to_bottom_of_box();
                        }, 400);
                    }

                    // read this message if this page is open
                    if(message.owner_id == mythis.client_id && !message.message_id){ 

                        // read this msg signal
                        mythis.socket.send(JSON.stringify({
                            '_type_request': 'seen',
                            'message_id': 'all-msg',
                            'message_sender': 'client',
                            'client_id': mythis.client_id,
                        }));
                    }

                };

                this.socket.onclose = function(e) {
                    console.error('Socket closed unexpectedly');
                };
            },
            
            show_user_chat_page(client_id, client_name, client_item, msg_type, index_item) {

                this.tab_data_is_show = false;
                this.show_msg_container = true;

                this.focus_msg_input();
                document.querySelectorAll('.chatapp .wrapper__chatboxes .chat__box').forEach(element => {
                    if(element.classList.contains('msg_item_active'))
                        element.classList.remove('msg_item_active');
                });
                document.querySelector(`.chatapp .wrapper__chatboxes .${client_item}`).classList.add('msg_item_active');
                document.querySelector('.chatapp .body__inputs').classList.remove('d-none');
                
                this.client_id = client_id;
                this.client_name = client_name;
                
                let formdata = new FormData();
                formdata.append('supporter_uid', this.supporter_uid);
                formdata.append('client_id', client_id);
                formdata.append('msg_type', msg_type);
                
                (async () => {
                    await fetch('/' + window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/supporter/read-all/', {
                        method: "POST",
                        body: new URLSearchParams(formdata),
                        headers: {
                            "Content-type": "application/x-www-form-urlencoded"
                        }
                    })
                    .then(response => response.json())
                    .then((response) => {
                        if(response.status == 200) {
                            
                            this.message_list = response.data;
                            console.log(response);

                            if(msg_type == 'thissupporter')
                                this.unreads_thissupporter[index_item].counter = 0;
                            else if(msg_type == 'nosupoorter')
                                this.unreads_nosupoorter[index_item].counter = 0;

                            setTimeout(()=> {
                                this.go_to_bottom_of_box();
                            }, 500);    

                            // send online status
                            let mythis = this;
                            this.socket.send(JSON.stringify({
                                '_type_request': 'status',
                                'status': 'online',
                                'user_id': 'supporter',
                                'client_id': mythis.client_id,
                            }));

                            // read all message signal
                            this.socket.send(JSON.stringify({
                                '_type_request': 'seen',
                                'message_id': 'all-msg',
                                'message_sender': 'client',
                                'client_id': mythis.client_id,
                            }));

                        }
                    })
                    .catch(err => {
                        console.log('ERR: ', err);
                    });
                })();
            },
           
            reset_close_chat_box() {
                document.querySelectorAll('.chatapp .wrapper__chatboxes .chat__box').forEach(element => {
                    if(element.classList.contains('msg_item_active'))
                        element.classList.remove('msg_item_active');
                });
                document.querySelector('.chatapp .body__inputs').classList.add('d-none');
                
                // send offline status
                let mythis = this;
                this.socket.send(JSON.stringify({
                    '_type_request': 'status',
                    'status': 'offline',
                    'user_id': 'supporter',
                    'client_id': mythis.client_id,
                }));

                this.receiver_status = '';
                this.client_id = '';
                this.client_name = '';
                this.msg_input = '';
                this.message_list = [];
                this.which_toggle_popup = '';
            },
            
            sned_msg_socket(e) {

                if(!this.msg_input)
                    return;

                if(!document.querySelector('section.chatapp .emoji_wrapper').classList.contains('d-none'))
                    document.querySelector('section.chatapp .emoji_wrapper').classList.add('d-none');

                if(this.message_status_is_edit) { /* just edit message */

                    let content = document.querySelector('.body__inputs .reply_msg_wrapper .reply__content').innerText;
                    let reply_id = document.querySelector('.body__inputs .reply_msg_wrapper .reply__reply_id').innerText;
                    let mythis = this;
                    this.socket.send(JSON.stringify({
                        '_type_request': 'edit',
                        'client_id': mythis.client_id,
                        'owner_id': mythis.supporter_uid,
                        'owner_name': '',
                        'id': 0,
                        'sender_type': 'supporter', 
                        'reply_id': reply_id,
                        'reply_title': '', 
                        'reply_msg': content, 
                        'is_seen': 0,
                        'created': '',
                        'text': mythis.msg_input,
                    }));

                    this.message_list.forEach(element => {
                        if(element.id == reply_id) {
                            element.text = mythis.msg_input;
                            element.is_edited = true;
                        }
                    });

                    this.message_status_is_edit = false;
                    this.msg_input = '';

                    this.close_replybar();
                    
                    setTimeout(()=> {
                        this.go_to_bottom_of_box();
                    }, 500);

                    return;
                }

                if(document.querySelector('.body__inputs .reply_msg_wrapper').classList.contains('d-none')) {
                    let mythis = this;
                    this.socket.send(JSON.stringify({
                        '_type_request': 'send',
                        'client_id': mythis.client_id,
                        'owner_id': mythis.supporter_uid,
                        'owner_name': '',
                        'id': 0,
                        'sender_type': 'supporter', 
                        'reply_id': '',
                        'reply_title': '', 
                        'reply_msg': '', 
                        'is_seen': 0,
                        'created': '',
                        'text': mythis.msg_input
                    }));    

                    // play send sound
                    this.play_send_sound();

                    setTimeout(()=> {
                        this.go_to_bottom_of_box();
                    }, 500);

                } 
                else {
                    let writer = document.querySelector('.body__inputs .reply_msg_wrapper .reply__writer').innerText;
                    let content = document.querySelector('.body__inputs .reply_msg_wrapper .reply__content').innerText;
                    let reply_id = document.querySelector('.body__inputs .reply_msg_wrapper .reply__reply_id').innerText;
                    let mythis = this;
                    this.socket.send(JSON.stringify({
                        '_type_request': 'send',
                        'client_id': mythis.client_id,
                        'owner_id': mythis.supporter_uid,
                        'owner_name': '',
                        'id': 0,
                        'sender_type': 'supporter', 
                        'reply_id': reply_id,
                        'reply_title': '', 
                        'reply_msg': content, 
                        'is_seen': 0,
                        'created': '',
                        'text': mythis.msg_input
                    }));

                    // play send sound
                    this.play_send_sound();

                    this.close_replybar();
                    
                    setTimeout(()=> {
                        this.go_to_bottom_of_box();
                    }, 500);
                }

                this.msg_input = '';
            },

            send_report() {
                
                let formdata = new FormData();
                formdata.append('supporter_uid', this.supporter_uid);
                formdata.append('client_id', this.client_id);
                formdata.append('report_cause', this.report_cause);
                formdata.append('report_item', this.report_item);

                (async () => {
                    await fetch('/' + window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/supporter/report/', {
                        method: "POST",
                        body: new URLSearchParams(formdata),
                        headers: {
                            "Content-type": "application/x-www-form-urlencoded"
                        }
                    })
                    .then(response => response.json())
                    .then((response) => {
                        if(response.status == 200) {

                            if(response.is_blocked) {
                                window.location.reload()
                            }

                            this.report_item = 'badterms';
                            this.report_cause = '';
                        }
                    })
                    .catch(err => {
                        console.log('ERR: ', err);
                    });
                })();
            },
            
            openclose_copyreadymsg() {
                if(this.which_toggle_popup != 'copybox') {

                    if(this.ready_msgs.length == 0) {
                        let formdata = new FormData();
                        formdata.append('supporter_uid', this.supporter_uid);

                        (async () => {
                            await fetch('/' + window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/supporter/ready-msg/get/', {
                                method: "POST",
                                body: new URLSearchParams(formdata),
                                headers: {
                                    "Content-type": "application/x-www-form-urlencoded"
                                }
                            })
                            .then(response => response.json())
                            .then((response) => {
                                if(response.status == 200) {
                                    this.ready_msgs = response.data;
                                }
                            })
                            .catch(err => {
                                console.log('ERR: ', err);
                            });
                        })();
                    }

                    this.which_toggle_popup = 'copybox';
                }else {
                    this.which_toggle_popup = '';
                }
            },

            edit_message(elementId, msgId) {
                this.message_status_is_edit = true;
                this.reply_msg(elementId, msgId);
            },

            delete_message(msgId) {

                let mythis = this;
                this.socket.send(JSON.stringify({
                    '_type_request': 'del',
                    'client_id': mythis.client_id,
                    'owner_id': mythis.supporter_uid,
                    'id': msgId,
                }));    

                this.message_list.forEach(element => {
                    if(element.id == msgId) 
                        element.is_deleted = true;
                    if(element.reply_id == msgId)
                        element.reply_is_deleted = true;
                });
            },

            delete_ready_msg(msgID) {
                let formdata = new FormData();
                formdata.append('supporter_uid', this.supporter_uid);
                formdata.append('msgID', msgID);

                (async () => {
                    await fetch('/' + window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/supporter/ready-msg/del/', {
                        method: "POST",
                        body: new URLSearchParams(formdata),
                        headers: {
                            "Content-type": "application/x-www-form-urlencoded"
                        }
                    })
                    .then(response => response.json())
                    .then((response) => {
                        if(response.status == 200) {
                            this.ready_msgs = response.data;
                        }
                    })
                    .catch(err => {
                        console.log('ERR: ', err);
                    });
                })();
            },

            copy_ready_msg(content) {
                const el = document.createElement('textarea');
                el.value = content;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            },

            submit_new_readymsg() {

                if(this.new_readymsg_subject.length < 4)
                    return;

                if(this.new_readymsg_content.length < 4)
                    return;
                
                let formdata = new FormData();
                formdata.append('supporter_uid', this.supporter_uid);
                formdata.append('subject', this.new_readymsg_subject);
                formdata.append('content', this.new_readymsg_content);

                (async () => {
                    await fetch('/' + window.location.pathname[1] + window.location.pathname[2] + '/django-chat-app/chat/supporter/ready-msg/create/', {
                        method: "POST",
                        body: new URLSearchParams(formdata),
                        headers: {
                            "Content-type": "application/x-www-form-urlencoded"
                        }
                    })
                    .then(response => response.json())
                    .then((response) => {
                        if(response.status == 200) {
                            this.ready_msgs = response.data;
                            this.new_readymsg_subject = '';
                            this.new_readymsg_content = '';
                            this.alert = 'پیام شما با موفقیت ذخیره شد. شما میتوانید هنگام چت با کاربران از این پیام استفاده کنید.'
                        }

                        setTimeout(() => {
                            this.alert = '';
                        }, 3000);
                    })
                    .catch(err => {
                        console.log('ERR: ', err);
                    });
                })();
            },

        }
    }).mount('#chatapp');

</script>

<!-- <script>
    document.onclick = hideMenu;
    document.oncontextmenu = rightClick;

    function hideMenu() {
        document.getElementById("contextMenu").style.display = "none"
    }

    function rightClick(e) {
        e.preventDefault();

        var menu = document.getElementById("contextMenu")
        menu.style.display = 'block';
        menu.style.left = (e.layerX) + "px";
        menu.style.top = (e.layerY) + "px";
        console.log(e);
    }
</script> -->

</body>
</html>